---
output: github_document
always_allow_html: yes
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
options(width = 130)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```
# dscore

<!-- badges: start -->
<!-- badges: end -->

The `dscore` package contains tools to

- Calculate D-score from item level responses
- Transform the D-scores into DAZ, age-standardised Z-scores

The required input consists of *item level* responses on milestones
from widely used instruments for measuring child development.

## Installation

You can install the released version of dscore from [CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("dscore")
```

And the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("remotes")
remotes::install_github("stefvanbuuren/dscore")
```

## Example

### Inspect the data

The `milestones` dataset in the `dscore` package contain responses
of 27 preterm children measured at various age between birth and 2.5 
years on the Dutch Development Instrument (DDI). The dataset looks 
like:

```{r milestones}
library(dscore)
head(milestones[, c(1, 3, 4, 9:15)])
```

Each row corresponds to a visit. Most children have three or four visits.
Columns starting with `ddi` hold the responses on DDI-items. A 
`1` means a PASS, a `0` means a FAIL, and `NA` means that the item was 
not administered.

The `get_labels()` function obtains the labels of the milestones, e.g.,

```{r}
items <- names(milestones)[9:15]
labels <- get_labels(items)
print(data.frame(items, labels), right = FALSE, row.names = FALSE)
```

### Calculate the D-score and DAZ

The `milestones` dataset has properly named columns that identifies each
item. Calculating the D-score and DAZ is then done by:

```{r}
ds <- dscore(milestones)
dim(ds)
```

where `ds` is a `data.frame` with the same number of rows than the input 
data. The first six rows are

```{r}
head(ds)
```

The table below provides the interpretation of each column: 

Name | Interpretation
---- | -------------
a    | Decimal age
n    | Number of items used to calculate D-score
p    | Percentage of passed milestones
d    | D-score estimate, mean of posterior
sem  | Standard error of measurement, standard deviation of the posterior
daz  | D-score corrected for age

### Graphs of D-score and DAZ

The `milestones` data and the result can be combined as

```{r}
md <- cbind(milestones, ds)
```

The individual developmental curves of 27 children can be plotted.

```{r graphD, dpi = 144}
library(ggplot2)
ggplot(md, aes(x = a, y = d, group = id, color = sex)) + 
  xlab("Age (in years)") + 
  ylab("D-score") +
  geom_line(lwd = 0.1) +
  geom_point(size = 1) +
  scale_colour_hue(l = 45) +
  theme_light()
```

The DAZ is an age-standardized D-score with a standard normal distribution
with mean 0 and variance 1. The individual DAZ curves are plotted as

```{r graphDAZ, dpi = 144}
ggplot(md, aes(x = a, y = daz, group = id, color = sex)) + 
  theme_light() +
  geom_rect(xmin = 0, xmax = 3, ymin = -2, ymax = 2, 
            fill = "grey97", linetype = 0, show.legend = FALSE) +
  geom_hline(yintercept = -1:1, colour = "white", lwd = 0.5) +
  coord_cartesian(ylim = c(-4, 4)) +
  geom_line(lwd = 0.1) +
  geom_point(size = 1) +
  scale_colour_hue(l = 45) +
  xlab("Age (in years)") +
  ylab("DAZ")
```

Note that the D-scores and DAZ are a little lower than average. The 
explanation here is that these all children are born preterm.

### Tools for mapping item names

The `dscore()` function assumes that the item names follow the 
GSED naming convention, a nine-position word that identifies the instrument,
the domain, the administration mode and the item number. You may 
decompose an item names into these components, as follows:

```{r}
decompose_itemnames(items)
```

which gives four components of the seven items. 

In practice, 
you will spend most of your time in renaming your own item names according
to the GSED convention. In order to ease this process, the `dscore` 
package offers several functions that can help.

First of all, the measurement instrument needs to be one of the instruments
supported by the `dscore` package. Here's the table of instruments that
are currently defined in the package:

Code | Items | Instrument
---- | -----:| -----------------------
aqi  | 230   | 
bar  |  22   | 
bat  | 137   |
by1  | 156   |  
by2  | 121   |
by3  | 320   |
cro  | 149   |
ddi  |  77   |
den  | 111   |
dmc  |  66   |
gri  | 312   |
hyp  |   5   |
iyo  |  90   |
kdi  |  69   |
mac  |   6   |
mds  |   6   |
mdt  | 136   |
peg  |   2   |
pri  |  63   |
sbi  |  33   |
sgr  |  58   |
tep  |  61   |
vin  |  50   |

Not every defined instruments can be used to calculate the D-score. There
are currently three keys in the software: `dutch`, 
`gcdg` and `gsed`. Different keys cover different sets of 
instruments. The table below displays the number of items 
per instrument under each of the three keys.

| Code | Items | dutch | gcdg  | gsed  |
| ---- | -----:| -----:| -----:| -----:|
| aqi  | 230   |       |   29  |   17
| bar  |  22   |       |   15  |   13
| bat  | 137   |       |       |
| by1  | 156   |       |   85  |   76
| by2  | 121   |       |   16  |   16
| by3  | 320   |       |  105  |   67
| cro  | 149   |       |       |   62
| ddi  |  77   |   76  |   65  |   64
| den  | 111   |       |   67  |   50
| dmc  |  66   |       |       |   43
| gri  | 312   |       |  104  |   93
| hyp  |   5   |       |       |
| iyo  |  90   |       |       |   55
| kdi  |  69   |       |       | 
| mac  |   6   |       |    3  |    3
| mds  |   6   |       |       |    1
| mdt  | 136   |       |       |  126
| peg  |   2   |       |    1  |    1
| pri  |  63   |       |       |
| sbi  |  33   |       |    6  |    1
| sgr  |  58   |       |   19  |   19
| tep  |  61   |       |   33  |   31
| vin  |  50   |       |   17  |   17
|      |       |       |       |
| ALL  |2280   |   76  |  565  |  807

In practice, the means that key choice is limited by the available
instrument. For example, if you have collected `cro`, then the only 
choice is the `gsed` key, but for `gri`, we may choose between 
`gcdg` and `gsed`. The actual choice will depend on the goals of your 
analysis. If you want to compare to other D-scores calculated under 
key `gcdg`, then pick the `gcdg` key. If that is not the case, then
`gsed` is the better choice since it account for a wider variety of 
instruments. By default, `gsed` is chosen.



