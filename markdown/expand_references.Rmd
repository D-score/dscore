---
title: "D-scores and references for ages 2-4 years"
author: "Stef van Buuren, Elise Dusseldorp, Bernice Doove"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{D-score and references, 2-4 years}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 7, fig.height = 7)
```

## Objective

The document `expand_tau.html` describes how the Rasch model 
was used to estimate difficulty levels of 19 items for ages 2-4 years 
of the \emph{Dutch Developmental Instrument} (DDI). That was done such 
that the published difficulties for items 0-2 years did not change.
This vignette shows how new reference values for the D-score for the 
age range 2-4 years are created.

## Overview of added items 

The added items, ordered by difficulty level `tau`, are:

```{r}
library("dscore")
library("dplyr", warn.conflicts = FALSE)
library("tidyr")
library("ddata")
added <- filter(itembank, substr(lex.jam, 1, 1) == "v" & !is.na(tau)) %>%
  select(lex.jam, labelEN, tau) %>%
  arrange(tau)
print(added, right = FALSE, row.names = FALSE)
```

There are 19 new items in the table, so combined with the already existing 
item bank of 57 items (covering ages 0-2 years), there are now 76 calibrated 
items.

## Current reference values

Table 4 of Van Buuren (2014) contains reference values of the D-score for the 
ages range 0.5-30 months. The references apply to both boys and girls. 
The data frame `Dreference` of the `dscore` package stores a slightly expanded 
version of these references that extend the ages to month 33.

```{r}
select(Dreference, 1:7) %>% slice(c(1:2, (n()-1):n()))
```

The reference values can be visualized in the form of a growth chart.

```{r echo=FALSE}
reference <- Dreference
select <- reference$month<30
select2 <- select1 <- select
select1[123:131] <- FALSE
select2[1:125] <- FALSE

# oldpar <- par(mai=c(0.6, 0.6, 0.6, 0.6))
matplot(x=reference$month[select],y=reference[select,c("SDM2","SDM1","SD0","SDP1","SDP2")],
        xlab="",ylab="",
        xlim=c(0,30),ylim=c(0,75),type='n',
        xaxp=c(0,30,10),yaxp=c(0,70,7),las=1)
axis(3,xaxp=c(0,30,10))
axis(4,yaxp=c(0,70,7),las=1)
polygon(x=c(reference$month[select],rev(reference$month[select])),
        y=c(reference[select,"SDM2"],rev(reference[select,"SDP2"])),
        col="grey98", border=NA)
abline(v=seq(0,30,3),lty=1,col="gray")
abline(h=seq(0,70,10),lty=1,col="gray")
rect(xleft=-3,xright=+6,ybottom=75,ytop=80,col="gray70",border=NA)
text(x=0,y=76.6,labels="D-SCORE (D)",cex=0.8,col="white",adj=0,font=2)
rect(xleft=-3,xright=+6,ybottom=-5,ytop=0,col="gray70",border=NA)
text(x=0,y=-1.6,labels="AGE (MONTH)",cex=0.8,col="white",adj=0,font=2)
rect(xleft=24,xright=+36,ybottom=-5,ytop=0,col="gray70",border=NA)
text(x=25,y=-1.6,labels="NL 2010",cex=0.8,col="white",adj=0,font=2)

matlines(x=reference$month[select1],y=reference[select1,c("SDM2","SDM1","SD0","SDP1","SDP2")],
         lty=c(1,2,3,2,1),type='l',lwd=1, col="gray50")
matlines(x=reference$month[select2],y=reference[select2,c("SDM2","SDM1","SD0","SDP1","SDP2")],
         lty=c(1,2,3,2,1),type='l',lwd=1, col="gray50")
labpos <- cbind(x=29,y=c(62.1,65,67.9,70.7,73.5))
#rect(xleft=labpos[,1]-0.8,xright=labpos[,1]+0.1,ybottom=labpos[,2]-1,ytop=labpos[,2]+1,
#      col="white",border=NA)
text(x=labpos,label=c("-2","-1","0","+1","+2"),cex=0.6,adj=1)
#temp <- legend(x="topleft",inset=0.05, legend=rep(" ",5),
#               text.width=strwidth(" -2 SD"), lty=c(1,2,3,2,1), 
#               lwd=1, cex=0.7, adj=c(1,0.5), box.col="transparent", 
#               bg="grey99", col="grey50")
#text(temp$rect$left+temp$rect$w, temp$text$y, 
#    c(" +2 SD"," +1 SD", " 0 SD"," -1 SD"," -2 SD"), cex=0.7, pos=2) 
#mtext("Netherlands 2010", side=1, line=3, cex=0.7, at=0, adj=0) 
# mtext("Boys and girls", side=1, line=3, cex=0.6, at=0, adj=0) 
# mtext("Males", side=1, line=3, cex=0.7, at=20) 
box()
# par(oldpar)
```

The task is to extend this graph to the age of 4 years. The extended
reference should connect smoothly, either at the age of 24 months, or at the 
age of 30 months.


## Count model for age-based prior

The D-score calculation requires specification of a prior distribution of the 
D-score. The prior delivers a starting point for the calculation of the 
D-score by the EAP method. The primary function of the prior 
is to enable estimation of the D-score in the
perfect pattern, for example, if the child passes all items. 

The `adp()` function return the age-dependent prior, and takes current 
age (in years) as input. 
Internally, the `adp()` function look into the `Dreference` object, and 
returns the density of the 
normal distribution, with mean set equal to `mu` (the median D-score) linearly 
interpolated at the requested age, and with the standard deviation set equal 
to 5. This densitys is used a the prior for the D-score calculation implemented
in the `dscore()` function.

In order to start off the D-score estimation at age > 30 months, we need to 
create a provisional set of the median D-score (`mu`) for ages 30-48 months. 
The following fits
a simple adaptation of the model proposed by Count (1943): 
$$y = \beta t + \gamma log(t + 1)$$
where $y$ is the median D-score, and where $t$ is age in years. 
Instead of $t + 1$, taking $t + 0.25$ gives a better fit.

```{r}
fit <- lm(mu ~ year + I(log(year + 0.25)), data = Dreference)
round(coef(fit), 2)
```

The Count model for the median D-score is close to perfection.
The proportion of explained variance is equal to 
`r cor(Dreference$mu, fitted.values(fit))^2`.
The original (grey) and extrapolated (green) median D-score look like

```{r echo = FALSE}
plot(x = Dreference$month, y = Dreference$mu, 
     xlim = c(0, 48), ylim = c(0, 80), 
     xaxp = c(0, 48, 8),
     type = "l", lwd = 6, col = "grey", 
     xlab = "Age (months)", ylab = "Median D-score (mu)")
abline(h = seq(0, 80, 10), v = seq(0, 48, 6), col = "grey90", lty = 3)
newx <- data.frame(year = seq(0, 4, 1/12))
plus30 <- select(Dreference, month, year, mu) %>% 
  filter(month > 30)
# points(x = plus30$month, y = plus30$mu, col = "blue")
lines(x = newx$year*12, y = predict(fit, newdata = newx), lty = 2, lwd = 2, 
      col = "olivedrab")
```

We can therefore define the prior as the normal distrbution with the mean 
set according to the Count model: $N(44.35 - 1.8t + 28.47 \ln (t + 0.25), 25)$. 

## D-score estimation

D-scores can be estimated using two data sources. First, we estimate the D-score
from 57 items `n1:n57` scored in the SMOCC data during 10 visits over a period 0-2.5 years. 
The SMOCC data are available as the `NL` object from the `ddata` package. The 
the `dscore()` function from the `dscore` package implement the EAP estimator. 
The argument `mu = "model"` specifies that the Count model prior. 

The expected value of the D-score by child 
and age can be calculated as:

```{r estimate1, cache = TRUE}
nl1_dscore <- NL %>%
  mutate(age = agedays / 365.25) %>%
  select(id, wave, age, n1:n57) %>%
  gather(item, score, n1:n57, na.rm = TRUE) %>%
  arrange(id, age) %>%
  group_by(id, age) %>%
  summarise(d = dscore(score, item, age, mu = "model", lexicon = "jam")) %>%
  ungroup()
```

Data on 18 common items and 20 new items were collected by Bernice Doove. The new variables are 

```{r items}
items <- c("n38", "n39", "n44", "n45", "n51", "n52", "n53", "v20", 
                 "v21", "v22", "v23", "v24", "v25", "v26", "v27", "n2", 
                 "n47", "v42", "n55", "n56", "v45", "v46", "v47",
                 "v48", "v49", "v50", "n35", "n42", "n43", "n49", "n50",
                 "n57", "v72", "v73", "v74", "v75")
vars <- c(c("country", "study", "id", "wave", "agedays"), items)
doove <- select_(gcdg, .dots = vars) %>%
  filter(study == "Netherlands 2")
```

Item `v40` ("Understand play orders") is not present in the item bank because
there was insufficient information in calibration data. 

The D-score, based on 18 "old" and 19 "new" items, can be calculated by

```{r estimate2, cache = TRUE}
varnames <- c("id", "wave", "age", items)
nl2_dscore <- doove %>%
  mutate(age = agedays / 365.25) %>%
  select_(.dots = varnames) %>%
  gather_("item", "score", items, na.rm = TRUE) %>%
  arrange(id, age) %>%
  group_by(id, age) %>%
  summarise(d = dscore(score, item, age, mu = "model", lexicon = "jam")) %>%
  ungroup()
```


## Distribution of D-score by age

```{r plotdscores, echo = FALSE}
plot(x = NULL, y = NULL, xlim = c(0, 48), ylim = c(0, 80),
     xaxp = c(0, 48, 8),
     xlab = "Age (in months)", ylab = "D-score")
abline(h = seq(0, 80, 10), v = seq(0, 48, 6), col = "grey90", lty = 3)
xgrid <- seq(1/12, 4, 1/12)
prov_mu <- function(t) {44.35 - 1.8 * t + 28.47 * log(t + 0.25)}
lines(x = xgrid *12, y = prov_mu(xgrid), lty = 1, lwd = 3,
      col = "olivedrab")
with(nl1_dscore, points(x = age * 12, y = d, cex = 0.4, col = "navy"))
with(nl2_dscore, points(x = age * 12, y = d, cex = 0.4, col = "firebrick1"))
```

The figure plots the estimated D-score against age for both SMOCC children (blue 
points) and Doove children (red points). The green line in the middle corresponds
to the median D-score by age, of which the part beyond month 33 is extrapolated 
using the Count model. 

There figure highlights several interesting features:

1. Around the age of 24 months, the location and spread in the D-scores are similar
for the SMOCC and Doove children, which reflects that fact that both the SMOCC
and Doove study are based on representative samples;

2. The plateau of the Doove children between months 24 and 30 is higher because 
the Doove children were also scored on more, and more difficult, items than the
SMOCC children;

3. As expected, the distribution shift upwards with age, thus confirming the 
continuous and increasing nature of child development with age;

4. There are big gaps in the D-score distributions around 36 and 48 months. 
In general, the items are too easy for these ages, which reflects that the DDI 
was designed to identify children with delayed development (rather than those 
who are advanced). Children with normal and advanced development have all 
been collapsed into the plateau;

5. The median (green line) lies in the middle of the distribution for ages up 
to about 30 months. Beyond that age, the majority of children will be in the 
plateau, so now the median approaches the plateau. 

## Reference values for ages 2-4 years

Because of the plateau effect, the apparent variability in D-scores 
beyond the age of 30 months is substantially lower than the 
true variability in development. 

It will therefore not be possible to estimate use the Doove data to provide 
reasonable estimates of the distribution of the true (i.e., free of plateau 
effect) variability in development. Hence for now, we cannot calculate 
sensible reference values and standard deviation scores of development 
beyond the age of 30 months.

## Conclusions

The analyses indicate that the D-score can be extended to ages 2-4 years 
with the methodology used in this vignette. In partcular, 
it is reassuring that the distribution of the estimate D-scores progressively 
shifts with age, even despite the large plateau effect seen on the calibration 
data for 2-4 years.

As a part of the calculation of the D-score, we need to set an age-dependent 
prior distribution. Until now, we have set this as a normal distribution with 
a mean equal to the median of the D-score reference 0-2.5 years and a standard 
deviation of 5. However, as the reference table do not extend to age 4, we needed 
to set the prior in an alternative way. 
It turned out that the adapted Count model fitted the observed median D-score in the reference 
table almost perfectly. We were thus confident using the Count model for 
extrapolating the median to the later ages. We checked the differences 
between the classic and new prior-setting methods, and it turned out that the 
differences in the resulting D-score were negligible. 
Since the Count function is simpler and faster, we recommend it now as the 
preferred method to set the age-dependent mean of the prior.

The estimated difficulty levels of the Rasch model are insensitive to 
the plateau effect, and can be used to calculate D-scores at any age. However, 
the distribution of true development is misrepresented by the 
estimated D-score on this set of items, in particular at the upper end of the 
distribution. Hence, we cannot estimate proper references of normal development
from this calibration sample. In order to obtain such references, we 
would need a representative sample scored on more difficult developmental items.

